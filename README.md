# Tender API

Tender API — это api для управления тендерами, которое позволяет пользователям и организациям 
взаимодействовать через HTTP API. Проект построен с использованием FastAPI и PostgreSQL.

## 1. Сборка проекта

### Шаги по сборке:

1. Клонируйте репозиторий:
    ```bash
    git clone https://github.com/keykranz/tender-api.git
    cd tender-api
    ```

2. Убедитесь, что Docker и Docker Compose установлены:
    - Для проверки Docker:
      ```bash
      docker --version
      ```
    - Для проверки Docker Compose:
      ```bash
      docker-compose --version
      ```

3. Запустите проект:
    ```bash
    docker-compose up --build
    ```

4. Подождите, пока все сервисы поднимутся, и убедитесь, что приложение доступно по адресу:
    ```
    http://localhost:8080
    ```

### Описание файлов:

- **Dockerfile**:
  - Этот файл описывает процесс сборки контейнера на основе образа `python:3.9-slim`. 
  - Он включает установку необходимых зависимостей и копирование файлов проекта в контейнер.

- **docker-compose.yml**:
  - Внутри `docker-compose.yml` прописаны все переменные окружения для базы данных:
    - `POSTGRES_USERNAME`
    - `POSTGRES_PASSWORD`
    - `POSTGRES_DATABASE`
  - Описывает два сервиса: 
    - `app`: FastAPI сервер, работающий на порту `8080`.
    - `db`: сервис базы данных Postgres, работающий на порту `5432`.
  - Сервис `app` зависит от `db`, и его запуск происходит только после того, как Postgres станет доступным.

- **wait-for-it.sh**:
  - Это скрипт, который ждет, пока Postgres станет доступным, прежде чем запустить сервер.
  - Он нужен в случае, если база данных запускается медленнее, чем приложение, и гарантирует, что приложение начнет работу только после того, как база данных будет готова к подключению.

5. Откройте документацию к API (Swagger UI):
    ```
    http://localhost:8080/docs
    ```

6. Остановка проекта:
    Если вам нужно остановить проект, выполните:
    ```bash
    docker-compose down
    ```

7. Повторный запуск проекта:
    Для повторного запуска без пересборки образов:
    ```bash
    docker-compose up
    ```

## 2. Сущности в базе данных

База данных проекта построена на PostgreSQL и автоматически инициализируется при первом запуске Docker контейнера с помощью скрипта `init.sql`, который находится по пути `docker-entrypoint-initdb.d/init.sql`. Этот скрипт создает все необходимые таблицы и заполняет их стартовыми тестовыми данными.

### Описание сущностей:

#### 1. **Employee (Сотрудник)**
Содержит информацию о сотрудниках системы.
- Поля:
  - `id` (UUID) — уникальный идентификатор.
  - `username` (VARCHAR) — имя/логин пользователя.
  - `first_name` (VARCHAR) — имя.
  - `last_name` (VARCHAR) — фамилия.
  - `created_at` (TIMESTAMP) — дата создания.
  - `updated_at` (TIMESTAMP) — дата последнего обновления.

#### 2. **Organization (Организация)**
Хранит информацию об организациях.
- Поля:
  - `id` (UUID) — уникальный идентификатор.
  - `name` (VARCHAR) — название организации.
  - `description` (TEXT) — описание организации.
  - `type` (ENUM) — тип организации.
  - `created_at` (TIMESTAMP) — дата создания.
  - `updated_at` (TIMESTAMP) — дата последнего обновления.

#### 3. **Organization Responsible (Ответственный за организацию)**
Связывает организации с ответственными сотрудниками.
- Поля:
  - `id` (UUID) — уникальный идентификатор.
  - `organization_id` (UUID) — ссылка на организацию.
  - `user_id` (UUID) — ссылка на сотрудника.

#### 4. **Tender (Тендер)**
Хранит информацию о тендерах, создаваемых организациями.
- Поля:
  - `id` (UUID) — уникальный идентификатор.
  - `tender_root_id` (UUID) — корневой идентификатор тендера для сквозного поиска версий.
  - `organization_id` (UUID) — ссылка на организацию.
  - `creator_id` (UUID) — ссылка на создателя тендера.
  - `title` (VARCHAR) — название тендера.
  - `description` (TEXT) — описание тендера.
  - `status` (ENUM) — статус тендера (создан, опубликован, закрыт).
  - `service_type` (ENUM) — тип тендера (строительство, IT-услуги, консалтинг).
  - `version` (INT) — версия тендера.
  - `created_at` (TIMESTAMP) — дата создания.
  - `updated_at` (TIMESTAMP) — дата последнего обновления.

#### 5. **Bid (Предложение)**
Предложения на участие в тендерах.
- Поля:
  - `id` (UUID) — уникальный идентификатор.
  - `tender_id` (UUID) — ссылка на тендер.
  - `bid_root_id` (UUID) — корневой идентификатор предложения для сквозного поиска версий.
  - `organization_id` (UUID) — ссылка на организацию.
  - `creator_id` (UUID) — ссылка на создателя предложения.
  - `amount` (NUMERIC) — денежная стоимость предложения.
  - `title` (VARCHAR) — название предложения.
  - `description` (TEXT) — описание предложения.
  - `status` (ENUM) — статус предложения (создано, опубликовано, отменено, одобрено, отклонено).
  - `version` (INT) — версия предложения.
  - `quorum` (INT) — кворум для одобрения предложения.
  - `created_at` (TIMESTAMP) — дата создания.
  - `updated_at` (TIMESTAMP) — дата последнего обновления.

#### 6. **Bid Decision (Решение по предложению)**
Хранит решения сотрудников по предложениям.
- Поля:
  - `id` (UUID) — уникальный идентификатор.
  - `bid_id` (UUID) — ссылка на предложение.
  - `user_id` (UUID) — ссылка на сотрудника.
  - `decision` (ENUM) — принятое решение (одобрено, отклонено).
  - `decision_date` (TIMESTAMP) — дата принятия решения.

#### 7. **Review (Отзыв)**
Отзывы о предложениях.
- Поля:
  - `id` (UUID) — уникальный идентификатор.
  - `bid_id` (UUID) — ссылка на предложение.
  - `reviewer_id` (UUID) — ссылка на сотрудника, оставившего отзыв.
  - `author_id` (UUID) — ссылка на автора предложения.
  - `content` (TEXT) — содержание отзыва.
  - `rating` (INT) — оценка от 1 до 5.
  - `created_at` (TIMESTAMP) — дата создания.

### Автоматическая инициализация данных

Скрипт `init.sql` выполняет следующие действия:
- Создает необходимые таблицы для сотрудников, организаций, тендеров, предложений, решений и отзывов.
- Добавляет тестовых сотрудников и организации.
- Связывает сотрудников с организациями.

Примеры тестовых данных:
- Сотрудники:
  - `user1` (John Doe)
  - `user2` (Alice Smith)
  - `user3` (Bob Jackson)
- Организации:
  - Tech Solutions 
  - Business Innovations 

---

## 3. API Эндпоинты

API предоставляет эндпоинты для работы с тендерами и предложениями. Все запросы работают через HTTP и возвращают данные в формате JSON.

> **Примечание:** В соответствии с техническим заданием не было четко указано, на каком этапе должна происходить авторизация/аутентификация пользователей. Поэтому для повышения безопасности и предотвращения несанкционированного доступа, в каждом эндпоинте были добавлены дополнительные проверки на доступность запроса для пользователя. Это помогает закрыть потенциальные уязвимости в системе.


### 1. Общие эндпоинты

#### **GET** `/api/ping`
Эндпоинт для проверки работоспособности сервера.

- Ответ:
  - 200 OK
  - Тело ответа: `"ok"`

---

### 2. Эндпоинты для работы с тендерами

#### **GET** `/api/tenders`
Получение списка всех тендеров. 

- Параметры:
  - `username` (string, опционально) — имя пользователя для получения дополнительных записей (статусы CREATE и CLOSED).
  - `service_type` (string, опционально) — тип услуги для фильтрации (например, "Construction", "IT Services", "Consulting").

- Ответ:
  - 200 OK: список тендеров.
  - 404 Not Found: если тендеры не найдены для указанного пользователя.
  - 422 Unprocessable Entity: если указан неправильный тип услуги в параметре `service_type`.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---

#### **GET** `/api/tenders/my`
Получение списка тендеров, доступных конкретному пользователю.

- Параметры:
  - `username` (string) — имя пользователя.

- Ответ:
  - 200 OK: список тендеров.
  - 404 Not Found: если пользователь не найден или тендеры для пользователя не найдены.
  - 403 Forbidden: если пользователь не авторизован для доступа к тендерам.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---

#### **POST** `/api/tenders/new`
Создание нового тендера.

- Параметры: 
  `username` (string, опционально) — имя пользователя.

- Тело запроса:
  - `title` (string) — название тендера.
  - `description` (string) — описание тендера.
  - `service_type` (string) — тип услуги (например, "Construction", "IT Services", "Consulting").

- Ответ:
  - 201 Created: созданный тендер.
  - 400 Bad Request: если отсутствуют обязательные поля `title`, `description`, или `service_type`.
  - 422 Unprocessable Entity: если поля `title` (должно быть от 3 до 100 символов), `description` (не более 500 символов) или `service_type` (допустимые значения: "Construction", "IT Services", "Consulting") не соответствуют требованиям.
  - 403 Forbidden: если пользователь не имеет прав создавать тендеры для организации.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---

#### **PATCH** `/api/tenders/{tender_id}/status`
Обновление статуса тендера.

- Параметры:
  - `tender_id` (UUID) — ID тендера.
  - `new_status` (string) — новый статус тендера (допустимые значения: "PUBLISHED", "CLOSED").
  - `username` (string, опционально) — имя пользователя.

- Ответ:
  - 200 OK: обновленный тендер.
  - 400 Bad Request: если статус не соответствует допустимым значениям.
  - 403 Forbidden: если пользователь не имеет прав на изменение статуса тендера.
  - 404 Not Found: если тендер не найден.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---

#### **PATCH** `/api/tenders/{tender_id}/edit`
Редактирование тендера.

> **Примечание:** В исходных примерах из задания при редактировании тендера не предусматривалась передача данных о пользователе, что могло бы привести к тому, что тендеры могли редактировать любые пользователи, вне зависимости от их принадлежности к организации. В данном решении была добавлена проверка, чтобы только пользователи, связанные с организацией, могли изменять информацию о тендере. Это предотвращает несанкционированное изменение данных.

- Параметры:
  - `tender_id` (UUID) — ID тендера.
  - `username` (string, опционально) — имя пользователя.
  
- Тело запроса:
  - `title` (string) — новое название.
  - `description` (string) — новое описание.

- Ответ:
  - 200 OK: отредактированный тендер.
  - 400 Bad Request: если отсутствуют обязательные поля `title` и `description`.
  - 422 Unprocessable Entity: если поля `title` или `description` не соответствуют требованиям.
  - 403 Forbidden: если пользователь не имеет прав на редактирование тендера.
  - 404 Not Found: если тендер не найден.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---

#### **PUT** `/api/tenders/{tender_id}/rollback/{version}`
Откат тендера к указанной версии.

- Параметры:
  - `tender_id` (UUID) — ID тендера.
  - `version` (integer) — версия, к которой необходимо откатить.
  - `username` (string, опционально) — имя пользователя.

- Ответ:
  - 200 OK: тендер, после отката к указанной версии.
  - 404 Not Found: если указанная версия не найдена.
  - 403 Forbidden: если пользователь не имеет прав на откат версии тендера.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---

### 3. Эндпоинты для работы с предложениями (Bids)

#### **GET** `/api/bids`
Получение списка предложений.

- Параметры:
  - `username` (string, опционально) — имя пользователя.

- Ответ:
  - 200 OK: список предложений.
  - 403 Forbidden: если пользователь не имеет прав доступа к предложениям организации.
  - 404 Not Found: если предложения не найдены для указанного пользователя.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---

#### **GET** `/api/bids/my`
Получение списка предложений, созданных текущим пользователем.

- Параметры:
  - `username` (string) — имя пользователя.

- Ответ:
  - 200 OK: список предложений.
  - 404 Not Found: если предложения не найдены для пользователя.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---

#### **POST** `/api/bids/new`
Создание нового предложения.

> **Примечание:** В соответствии с требованиями технического задания, пользователи могут создавать предложения только от имени организаций, с которой они связаны.

- Параметры:
  - `username` (string, опционально) — имя пользователя.

- Тело запроса:
  - `title` (string) — название предложения.
  - `description` (string) — описание предложения.
  - `amount` (numeric) — сумма предложения.
  - `tender_id` (UUID) — идентификатор тендера, к которому привязано предложение.

- Ответ:
  - 201 Created: новое предложение.
  - 400 Bad Request: если отсутствуют обязательные поля `title`, `description`, или `amount`.
  - 403 Forbidden: если пользователь не имеет прав на создание предложения для организации.
  - 404 Not Found: если тендер не найден.
  - 422 Unprocessable Entity: если данные не соответствуют требованиям (например, некорректная сумма или длина описания).
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---

#### **GET** `/api/bids/{tender_id}/list`
Получение списка предложений для конкретного тендера.

> **Примечание:** Пользователь может просматривать предложения только для тендеров, к которым он имеет доступ в своей организации.

- Параметры:
  - `tender_id` (UUID) — идентификатор тендера.
  - `username` (string, опционально) — имя пользователя.

- Ответ:
  - 200 OK: список предложений для указанного тендера.
  - 403 Forbidden: если пользователь не имеет прав доступа к тендеру.
  - 404 Not Found: если предложения для тендера не найдены.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---

#### **PATCH** `/api/bids/{bid_id}/status`
Обновление статуса предложения.

- Параметры:
  - `bid_id` (UUID) — ID предложения.
  - `new_status` (string) — новый статус предложения (допустимые значения: "CREATED", "PUBLISHED", "CANCELED", "APPROVED", "REJECTED").
  - `username` (string, опционально) — имя пользователя, инициирующего запрос.

- Ответ:
  - 200 OK: обновленное предложение.
  - 400 Bad Request: если статус не соответствует допустимым значениям.
  - 403 Forbidden: если пользователь не имеет прав на изменение статуса предложения.
  - 404 Not Found: если предложение не найдено.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---

#### **PATCH** `/api/bids/{bid_id}/edit`
Редактирование предложения.

- Параметры:
  - `bid_id` (UUID) — ID предложения.
  - `username` (string, опционально) — имя пользователя, инициирующего запрос.

- Тело запроса:
  - `title` (string) — новое название предложения.
  - `description` (string) — новое описание предложения.
  - `amount` (numeric) — новая сумма предложения.

- Ответ:
  - 200 OK: отредактированное предложение.
  - 400 Bad Request: если отсутствуют обязательные поля `title`, `description` или `amount`.
  - 422 Unprocessable Entity: если поля не соответствуют требованиям (например, `title` слишком короткое или длинное).
  - 403 Forbidden: если пользователь не имеет прав на редактирование предложения.
  - 404 Not Found: если предложение не найдено.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---
  
#### **PUT** `/api/bids/{bid_id}/rollback/{version}`
Откат предложения к указанной версии.

- Параметры:
  - `bid_id` (UUID) — ID предложения.
  - `version` (integer) — версия, к которой необходимо откатить.
  - `username` (string, опционально) — имя пользователя.

- Ответ:
  - 200 OK: предложение успешно откатано к указанной версии.
  - 403 Forbidden: если пользователь не имеет прав на откат предложения.
  - 404 Not Found: если версия предложения не найдена.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---

#### **POST** `/api/bids/submit_decision`
Отправка решения по предложению (одобрение или отклонение).
Решения по предложениям могут принимать только пользователи, связанные с организацией, которая участвовала в тендере.
- Если решение — "REJECTED", предложение сразу отклоняется.
- Если решение — "APPROVED", проверяется количество одобрений, и если их достаточно для достижения кворума, предложение одобряется.


- Параметры:
  - `bid_id` (UUID) — ID предложения.
  - `decision` (string) — принятое решение ("APPROVED" или "REJECTED").
  - `username` (string, опционально) — имя пользователя.

- Ответ:
  - 200 OK: предложение одобрено или отклонено.
  - 400 Bad Request: если предложение уже отклонено или одобрено, либо если пользователь уже отправил решение.
  - 403 Forbidden: если пользователь не имеет прав на принятие решения по предложению.
  - 404 Not Found: если предложение или тендер не найдены.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---

### 4. Эндпоинты для работы с отзывами (Reviews)

#### **GET** `/api/bids/{bid_id}/reviews`
Получение списка отзывов по предложению.

- Параметры:
  - `bid_id` (UUID) — ID предложения.
  - `authorUsername` (string) — имя пользователя автора предложений.

- Ответ:
  - 200 OK: список отзывов.
  - 403 Forbidden: если пользователь не имеет прав на просмотр отзывов.
  - 404 Not Found: если автор предложений или сами предложения не найдены.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---

#### **POST** `/api/bids/feedback`
Создание отзыва на предложение.

- Параметры:
  - `bid_id` (UUID) — ID предложения.
  - `authorUsername` (string) — имя пользователя автора предложения.
  
- Тело запроса:
  - `content` (string) — содержание.
  - `rating` (integer) — рейтинг.

- Ответ:
  - 201 Created: отзыв успешно создан.
  - 400 Bad Request: если автор не создавал это предложение.
  - 403 Forbidden: если пользователь не имеет прав на создание отзыва.
  - 404 Not Found: если автор или предложение не найдены.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---

### 5. Эндпоинты для дебага

#### **GET** `/api/debug/users`
Получение списка всех пользователей с привязанными организациями.

- Ответ:
  - 200 OK: список пользователей и их организаций.
  - 404 Not Found: если пользователи не найдены.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.

---

#### **GET** `/api/debug/tenders/company/{organization_id}`
Получение списка тендеров (все версии) для указанной компании (организации).

- Параметры:
  - `organization_id` (UUID) — ID организации.

- Ответ:
  - 200 OK: список тендеров для указанной организации.
  - 404 Not Found: если тендеры для данной компании не найдены.
  - 500 Internal Server Error: при возникновении непредвиденной ошибки сервера.
  
